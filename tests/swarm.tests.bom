brooklyn.catalog:
  version: 2.0.0_SNAPSHOT
  iconUrl: https://raw.githubusercontent.com/docker-library/docs/c350af05d3fac7b5c3f6327ac82fe4d990d8729c/docker/logo.png
  license_code: TODO
  license_url: TODO
  items:

  # Convenience entities

  - id: assert-up
    item:
      type: org.apache.brooklyn.test.framework.TestSensor
      name: TEST [service.isUp] IS [true]
      sensor: service.isUp
      assert:
      - equals: true

  - id: assert-running
    item:
      type: org.apache.brooklyn.test.framework.TestSensor
      name: TEST [service.state] IS [running]
      sensor: service.state
      assert:
      - matches: running

  - id: test-docker-client
    item:
      type: server
      pre.install.command: |
        # Install docker so we can use it as a client
        sudo yum -y update
        sudo tee /etc/yum.repos.d/docker.repo <<-'EOF'
        [dockerrepo]
        name=Docker Repository
        baseurl=https://yum.dockerproject.org/repo/main/centos/$releasever/
        enabled=1
        gpgcheck=1
        gpgkey=https://yum.dockerproject.org/gpg
        EOF
        sudo yum -y install docker-engine

  - id: test-connect-fails-without-tls
    item:
      type: org.apache.brooklyn.test.framework.TestCase
      name: Verify Connect Fails without TLS
      brooklyn.parameters:
        - name: swarm.url
          description: URL of the swarm endpoint
      brooklyn.children:
      - type: org.apache.brooklyn.test.framework.SimpleShellCommandTest
        command:
          $brooklyn:formatString:
          - "docker -H %s ps -a"
          - $brooklyn:config("swarm.url")
        assertStatus:
          equals: 1
        assertErr:
          contains: Are you trying to connect to a TLS-enabled daemon without TLS?


  - id: test-connect-succeeds-with-tls
    item:
      type: org.apache.brooklyn.test.framework.TestCase
      name: Test Connect Succeeds with TLS
      brooklyn.parameters:
        - name: swarm.url
          description: URL of the swarm endpoint
        - name: ca.url
          description: URL of the CA server
        - name: client.address
          description: Public address of the test client
      brooklyn.children:
      - type: org.apache.brooklyn.test.framework.SimpleShellCommandTest
        command:
          $brooklyn:formatString:
          - |
            echo Running in $(pwd)
            IP=%s; # client.address
            ca=%s; # ca.url
            swarm_url=%s; # swarm.url
            mkdir -p certs
            echo Getting certificates from ${ca}
            curl -X POST ${ca}/generate/${IP}
            curl ${ca}/cert/${IP}/ca.pem > certs/ca.pem
            curl ${ca}/cert/${IP}/cert.pem > certs/cert.pem
            curl ${ca}/cert/${IP}/key.pem > certs/key.pem
            tls_options="--tlsverify --tlscacert=certs/ca.pem --tlscert=certs/cert.pem --tlskey=certs/key.pem"
            echo Connecting to ${swarm_url} with TLS options ${tls_options}
            docker -H ${swarm_url} ${tls_options} ps -a
          - $brooklyn:config("client.address")
          - $brooklyn:config("ca.url")
          - $brooklyn:config("swarm.url")
        assertStatus:
          equals: 0
        assertOut:
          contains: "/swarm join"



